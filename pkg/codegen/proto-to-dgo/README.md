# Proto to DGO Generator

Package để tự động generate file `.d.go` từ file `.proto`, giúp giảm boilerplate code trong việc tạo NATS service wrappers.

## Tính năng

- Parse file `.proto` và extract service definitions
- Generate file `.d.go` với pattern chuẩn của project
- Sử dụng template system với file `.tmpl` riêng biệt để dễ customize
- Tự động tạo:
  - NATS subject constants
  - Service interface
  - Service proxy
  - Service router với NATS integration

## Cấu trúc

```
pkg/codegen/proto-to-dgo/
├── proto_parser.go       # Parser cho file .proto
├── dgo_generator.go      # Generator chính
├── templates/
│   └── generated.d.tmpl  # Template cho file .d.go
└── README.md
```

## Cách sử dụng

### CLI Command

```bash
# Generate .d.go file từ .proto file
go run pkg/codegen/cli/main.go -proto=<path-to-proto> -dgo-output=<output-path>

# Ví dụ:
go run pkg/codegen/cli/main.go -proto=apps/order/proto/order.proto -dgo-output=apps/order/api/order/order.d.go
```

### Programmatic Usage

```go
package main

import (
    "github.com/hoangdaochuz/ecommerce-microservice-golang/pkg/codegen/proto-to-dgo"
)

func main() {
    generator := proto_to_dgo.NewDGoGenerator()
    err := generator.GenerateFromProto("path/to/service.proto", "path/to/output.d.go")
    if err != nil {
        log.Fatal(err)
    }
}
```

## Input/Output

### Input (.proto file)
```protobuf
syntax = "proto3";

package order;
option go_package = "order/api/order";

service OrderService {
  rpc CreateOrder(CreateOrderRequest) returns (CreateOrderResponse);
  rpc GetOrderById(GetOrderByIdRequest) returns (OrderResponse);
}

message CreateOrderRequest {
  string customer_id = 1;
}

message CreateOrderResponse {
  string order_id = 1;
}

message GetOrderByIdRequest {
  string Id = 1;
}

message OrderResponse {
  string Id = 1;
  string Name = 2;
}
```

### Output (.d.go file)
```go
package order

import (
	"context"

	custom_nats "github.com/hoangdaochuz/ecommerce-microservice-golang/pkg/custom-nats"
)

const (
	NATS_SUBJECT          = "/api/v1/order"
	ORDER_CREATE_ORDER = NATS_SUBJECT + "/CreateOrder"
	ORDER_GET_ORDER_BY_ID = NATS_SUBJECT + "/GetOrderById"
)

type OrderServiceInterface interface {
	CreateOrder(ctx context.Context, req *CreateOrderRequest) (*CreateOrderResponse, error)
	GetOrderById(ctx context.Context, req *GetOrderByIdRequest) (*OrderResponse, error)
}

type OrderServiceProxy struct {
	service OrderServiceInterface
}

func NewOrderServiceProxy(service OrderServiceInterface) *OrderServiceProxy {
	return &OrderServiceProxy{
		service: service,
	}
}

func (o *OrderServiceProxy) CreateOrder(ctx context.Context, req *CreateOrderRequest) (*CreateOrderResponse, error) {
	return o.service.CreateOrder(ctx, req)
}

func (o *OrderServiceProxy) GetOrderById(ctx context.Context, req *GetOrderByIdRequest) (*OrderResponse, error) {
	return o.service.GetOrderById(ctx, req)
}

type OrderServiceRouter struct {
	proxy *OrderServiceProxy
}

func NewOrderServiceRouter(proxy *OrderServiceProxy) *OrderServiceRouter {
	return &OrderServiceRouter{
		proxy: proxy,
	}
}

func (o *OrderServiceRouter) Register(natsRouter custom_nats.Router) {
	natsRouter.RegisterRoute("POST", ORDER_CREATE_ORDER, o.proxy.CreateOrder)
	natsRouter.RegisterRoute("POST", ORDER_GET_ORDER_BY_ID, o.proxy.GetOrderById)
}
```

## Lợi ích

1. **Giảm boilerplate**: Không cần viết manually các proxy và router
2. **Consistency**: Đảm bảo tất cả services follow cùng một pattern
3. **Maintainability**: Khi thay đổi proto file, chỉ cần re-generate
4. **Type Safety**: Tự động generate với đúng types từ protobuf

## Workflow

1. Định nghĩa service trong file `.proto`
2. Generate protobuf code: `protoc --go_out=. --go-grpc_out=. *.proto`
3. Generate .d.go file: `go run pkg/codegen/cli/main.go -proto=... -dgo-output=...`
4. Implement actual service logic
5. Wire up dependency injection

## Customization

### Thay đổi template

Bạn có thể customize output bằng cách chỉnh sửa file `/templates/generated.d.tmpl`:

```go
// Ví dụ: thêm comments hoặc thay đổi naming convention
// File: templates/generated.d.tmpl

// Code generated by proto-to-dgo. DO NOT EDIT.
package {{.Package}}

import (
	"context"
	custom_nats "{{.ImportPath}}"
)

// Constants for NATS subjects
const (
	NATS_SUBJECT{{range $i, $method := .Methods}}{{if eq $i 0}} = "{{$.NatsSubject}}"{{end}}
	{{$method.ConstantName}} = NATS_SUBJECT + "/{{$method.Name}}"{{end}}
)

// {{.ServiceName}}Interface defines the contract for {{.ServiceName}}
type {{.ServiceName}}Interface interface {
{{- range .Methods}}
	{{.Name}}(ctx context.Context, req *{{.RequestType}}) (*{{.ResponseType}}, error)
{{- end}}
}
```

### Template Variables

Template có access đến:
- `{{.Package}}` - Package name
- `{{.ServiceName}}` - Service name từ proto
- `{{.ImportPath}}` - Import path cho custom-nats
- `{{.NatsSubject}}` - Base NATS subject
- `{{.Methods}}` - Array của methods với:
  - `{{.Name}}` - Method name
  - `{{.RequestType}}` - Request message type
  - `{{.ResponseType}}` - Response message type  
  - `{{.ConstantName}}` - Generated constant name

## Tương lai

- Support cho multiple services trong một proto file
- Multiple template options
- Integration với build pipeline (Makefile/Taskfile)
- Custom naming conventions
- Validation và error handling improvements
